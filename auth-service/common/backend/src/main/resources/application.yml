server:
  port: 8080

spring:
  # 기본 프로파일 설정 (명시적으로 지정하지 않으면 dev 사용)
  profiles:
    default: dev

  datasource:
    url: ${DB_URL:jdbc:mysql://localhost:3306/}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:root}

    # HikariCP Connection Pool 설정
    hikari:
      # 최대 커넥션 수 (프로덕션 권장: CPU 코어 수 * 2 + effective_spindle_count)
      maximum-pool-size: ${DB_POOL_MAX_SIZE:20}
      # 최소 유휴 커넥션 수
      minimum-idle: ${DB_POOL_MIN_IDLE:5}
      # 커넥션 타임아웃 (30초)
      connection-timeout: ${DB_POOL_CONNECTION_TIMEOUT:30000}
      # 유휴 커넥션 타임아웃 (10분)
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:600000}
      # 커넥션 최대 수명 (30분)
      max-lifetime: ${DB_POOL_MAX_LIFETIME:1800000}
      # 커넥션 누수 감지 임계값 (60초)
      leak-detection-threshold: ${DB_POOL_LEAK_DETECTION:60000}
      # 커넥션 테스트 쿼리
      connection-test-query: SELECT 1

  jpa:
    hibernate:
      ddl-auto: none

  # Transaction 타임아웃 설정 (30초)
  transaction:
    default-timeout: ${TRANSACTION_TIMEOUT:30}

  # Kafka 설정
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3

    consumer:
      group-id: boilerplate-service-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      properties:
        # SECURITY: "*" 사용 시 Insecure Deserialization 취약점 발생
        spring.json.trusted.packages: "com.hamkkebu.boilerplate.*"

  # Redis 설정
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}  # 비밀번호가 없으면 비워둠
      timeout: ${REDIS_TIMEOUT:2000ms}
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

# JWT 설정
jwt:
  secret: ${JWT_SECRET}  # REQUIRED: 환경 변수로 반드시 설정해야 함 (256-bit 이상)
  access-token-validity: ${JWT_ACCESS_TOKEN_VALIDITY:3600000}    # 1시간 (밀리초)
  refresh-token-validity: ${JWT_REFRESH_TOKEN_VALIDITY:604800000}  # 7일 (밀리초)

# Security 설정
security:
  rate-limiting:
    # SECURITY: 프록시 사용 여부
    # false: getRemoteAddr() 직접 사용 (기본값, 안전)
    # true: X-Forwarded-For 헤더 확인 (프록시 환경)
    trust-proxy: false
    # Rate limiting 설정 (개발 환경: 매우 높은 값)
    auth-requests-per-minute: 1000
    general-requests-per-minute: 5000
    window-size-seconds: 60

  login-attempt:
    # 최대 로그인 시도 횟수 (개발 환경: 20번)
    max-attempts: ${LOGIN_MAX_ATTEMPTS:20}
    # 계정 잠금 시간 (분) (개발 환경: 3분)
    block-duration-minutes: ${LOGIN_BLOCK_DURATION:3}
    # 로그인 시도 카운터 초기화 시간 (분)
    attempt-reset-minutes: ${LOGIN_ATTEMPT_RESET:15}

# gRPC 설정 (내부 서비스 간 통신)
grpc:
  server:
    port: ${GRPC_SERVER_PORT:9090}
  client:
    user-service:
      address: ${USER_SERVICE_GRPC_ADDRESS:static://localhost:9090}
      negotiationType: plaintext  # 개발 환경: plaintext, 프로덕션: TLS
      enable-keep-alive: true
      keep-alive-time: 30s
      keep-alive-timeout: 10s
    transaction-service:
      address: ${TRANSACTION_SERVICE_GRPC_ADDRESS:static://localhost:9090}
      negotiationType: plaintext
      enable-keep-alive: true
      keep-alive-time: 30s
      keep-alive-timeout: 10s

# Resilience4j Circuit Breaker 설정
resilience4j:
  circuitbreaker:
    instances:
      userService:
        # Circuit Breaker 동작 설정
        failure-rate-threshold: 50                    # 실패율 50% 초과 시 Circuit Open
        slow-call-rate-threshold: 50                  # 느린 호출 50% 초과 시 Circuit Open
        slow-call-duration-threshold: 2s              # 2초 이상 걸리면 느린 호출로 간주
        wait-duration-in-open-state: 10s              # Open 상태에서 10초 후 Half-Open으로 전환
        permitted-number-of-calls-in-half-open-state: 3  # Half-Open 상태에서 3개 요청 허용
        sliding-window-type: COUNT_BASED              # 카운트 기반 슬라이딩 윈도우
        sliding-window-size: 10                       # 최근 10개 호출 기준
        minimum-number-of-calls: 5                    # 최소 5개 호출 후 Circuit Breaker 활성화
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - io.grpc.StatusRuntimeException
      transactionService:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2s
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - io.grpc.StatusRuntimeException

  # Time Limiter 설정 (타임아웃)
  timelimiter:
    instances:
      userService:
        timeout-duration: 3s                          # gRPC 호출 타임아웃: 3초
      transactionService:
        timeout-duration: 3s

# Swagger UI 공통 설정
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: alpha
    tags-sorter: alpha
    display-request-duration: true
    disable-swagger-default-url: true
