server:
  port: 8080

spring:
  # 기본 프로파일 설정 (명시적으로 지정하지 않으면 dev 사용)
  profiles:
    default: dev

  datasource:
    url: ${DB_URL:jdbc:mysql://localhost:3306/}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:root}

    # HikariCP Connection Pool 설정
    hikari:
      # 최대 커넥션 수 (프로덕션 권장: CPU 코어 수 * 2 + effective_spindle_count)
      maximum-pool-size: ${DB_POOL_MAX_SIZE:20}
      # 최소 유휴 커넥션 수
      minimum-idle: ${DB_POOL_MIN_IDLE:5}
      # 커넥션 타임아웃 (30초)
      connection-timeout: ${DB_POOL_CONNECTION_TIMEOUT:30000}
      # 유휴 커넥션 타임아웃 (10분)
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:600000}
      # 커넥션 최대 수명 (30분)
      max-lifetime: ${DB_POOL_MAX_LIFETIME:1800000}
      # 커넥션 누수 감지 임계값 (60초)
      leak-detection-threshold: ${DB_POOL_LEAK_DETECTION:60000}
      # 커넥션 테스트 쿼리
      connection-test-query: SELECT 1

  jpa:
    hibernate:
      ddl-auto: none

  # Transaction 타임아웃 설정 (30초)
  transaction:
    default-timeout: ${TRANSACTION_TIMEOUT:30}

  # Kafka 설정
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3

    consumer:
      group-id: boilerplate-service-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      properties:
        # SECURITY: "*" 사용 시 Insecure Deserialization 취약점 발생
        spring.json.trusted.packages: "com.hamkkebu.boilerplate.*"

# Keycloak SSO 설정
keycloak:
  auth-server-url: ${KEYCLOAK_AUTH_SERVER_URL:http://localhost:8180}
  realm: ${KEYCLOAK_REALM:hamkkebu}
  client-id: ${KEYCLOAK_CLIENT_ID:hamkkebu-backend}
  client-secret: ${KEYCLOAK_CLIENT_SECRET:hamkkebu-backend-secret}

# Spring Security OAuth2 Resource Server 설정 (Keycloak 연동)
spring.security.oauth2.resourceserver.jwt:
  issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/hamkkebu}
  jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:http://localhost:8180/realms/hamkkebu/protocol/openid-connect/certs}

# gRPC 설정 (내부 서비스 간 통신)
grpc:
  server:
    port: ${GRPC_SERVER_PORT:9090}
  client:
    user-service:
      address: ${USER_SERVICE_GRPC_ADDRESS:static://localhost:9090}
      negotiationType: plaintext  # 개발 환경: plaintext, 프로덕션: TLS
      enable-keep-alive: true
      keep-alive-time: 30s
      keep-alive-timeout: 10s
    transaction-service:
      address: ${TRANSACTION_SERVICE_GRPC_ADDRESS:static://localhost:9090}
      negotiationType: plaintext
      enable-keep-alive: true
      keep-alive-time: 30s
      keep-alive-timeout: 10s

# Resilience4j Circuit Breaker 설정
resilience4j:
  circuitbreaker:
    instances:
      userService:
        # Circuit Breaker 동작 설정
        failure-rate-threshold: 50                    # 실패율 50% 초과 시 Circuit Open
        slow-call-rate-threshold: 50                  # 느린 호출 50% 초과 시 Circuit Open
        slow-call-duration-threshold: 2s              # 2초 이상 걸리면 느린 호출로 간주
        wait-duration-in-open-state: 10s              # Open 상태에서 10초 후 Half-Open으로 전환
        permitted-number-of-calls-in-half-open-state: 3  # Half-Open 상태에서 3개 요청 허용
        sliding-window-type: COUNT_BASED              # 카운트 기반 슬라이딩 윈도우
        sliding-window-size: 10                       # 최근 10개 호출 기준
        minimum-number-of-calls: 5                    # 최소 5개 호출 후 Circuit Breaker 활성화
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - io.grpc.StatusRuntimeException
      transactionService:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2s
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - io.grpc.StatusRuntimeException

  # Time Limiter 설정 (타임아웃)
  timelimiter:
    instances:
      userService:
        timeout-duration: 3s                          # gRPC 호출 타임아웃: 3초
      transactionService:
        timeout-duration: 3s

# Swagger UI 공통 설정
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: alpha
    tags-sorter: alpha
    display-request-duration: true
    disable-swagger-default-url: true
